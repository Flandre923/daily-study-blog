---
title: '12'
published: 2024-09-13
tags: ['å­¦ä¹ è®°å½•', 'å­¦ä¹ ç¬”è®°', 'Python']
description: Pythonå­¦ä¹ è®°å½•
image: https://cdn.jsdelivr.net/gh/Flandre923/CDN/img/b526b3ced0fff4679cb0175151313ce85e9e15efba558df916da15d8d7efb82a.png
category: Python
draft: false
---


# 12

# æ•°æ®åº“æ“ä½œï¼ˆCRUDsï¼‰

[https://res.cloudinary.com/zenn/image/fetch/s--wLFmL-2K--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_70/https://storage.googleapis.com/zenn-user-upload/avatar/b175d1b004.jpeg](https://res.cloudinary.com/zenn/image/fetch/s--wLFmL-2K--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_70/https://storage.googleapis.com/zenn-user-upload/avatar/b175d1b004.jpeg)â€‹[smithonisanäº2022.01.20æ›´æ–°](https://zenn.dev/sh0nk)

æœ¬ç« ç›®å½•

1. [C: åˆ›å»º](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#c%3A-create)

    1. [CRUDs](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#cruds)
    2. [è·¯ç”±å™¨](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC)
    3. [æ“ä½œç¡®è®¤](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D)
2. [R: è¯»å–](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#r%3A-read)

    1. [CRUDs](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#cruds-1)
    2. [è·¯ç”±å™¨](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC-1)
    3. [æ“ä½œç¡®è®¤](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D-1)
3. [U: æ›´æ–°](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#u%3A-update)

    1. [CRUDs](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#cruds-2)
    2. [è·¯ç”±å™¨](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC-2)
    3. [æ“ä½œç¡®è®¤](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D-2)
4. [D: åˆ é™¤](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#d%3A-delete)

    1. [CRUDs](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#cruds-3)
    2. [è·¯ç”±å™¨](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC-3)
    3. [æ“ä½œç¡®è®¤](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D-3)
5. [å®Œæˆèµ„æº](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#done%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9)

    1. [æ“ä½œç¡®è®¤](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D-4)
6. [æœ€ç»ˆç›®å½•ç»“æ„](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/b92ab0#%E6%9C%80%E7%B5%82%E7%9A%84%E3%81%AA%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E6%A7%8B%E6%88%90)

ä¸Šä¸€ç« æˆ‘ä»¬å‡†å¤‡äº†æ•°æ®åº“è¿æ¥å’ŒTODOåº”ç”¨çš„æ•°æ®åº“æ¨¡å‹ã€‚æœ¬ç« æˆ‘ä»¬å°†è¿æ¥æ•°æ®åº“è¿›è¡Œè¯»å†™å¤„ç†ï¼Œå¹¶é€šè¿‡APIæµ‹è¯•å…¶åŠŸèƒ½ã€‚

# C: åˆ›å»º

é¦–å…ˆï¼Œç”±äºæ•°æ®å°šä¸å­˜åœ¨ï¼Œæˆ‘ä»¬å°†é€šè¿‡ `POST`â€‹ `/tasks`â€‹ å¼€å§‹åˆ›å»ºã€‚

## CRUDs

è·¯ç”±å™¨å¯¹åº”äºMVCä¸­çš„æ§åˆ¶å™¨ã€‚å¦‚æœä½ ç†Ÿæ‚‰åƒRailsè¿™æ ·çš„MVCæ¡†æ¶ï¼Œä½ å¯èƒ½ä¼šè®¤ä¸ºæ§åˆ¶å™¨ä¼šå› ä¸ºè¿æ¥æ¨¡å‹å’Œè§†å›¾è€Œå˜å¾—åºå¤§ï¼ˆFat Controllerï¼‰ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å°†åœ¨ `api/cruds/task.py`â€‹ ä¸­ç¼–å†™æ‰§è¡Œæ•°æ®åº“CRUDæ“ä½œçš„é€»è¾‘ã€‚

api/cruds/task.py

```python
from sqlalchemy.ext.asyncio import AsyncSession

import api.models.task as task_model
import api.schemas.task as task_schema


async def create_task(
    db: AsyncSession, task_create: task_schema.TaskCreate
) -> task_model.Task:
    task = task_model.Task(**task_create.dict())
    db.add(task)
    await db.commit()
    await db.refresh(task)
    return task
```

è®©æˆ‘ä»¬åˆ—å‡ºæˆ‘ä»¬æ‰€åšçš„äº‹æƒ…çš„å¤§è‡´æµç¨‹ã€‚

1. æ¥æ”¶ä¸€ä¸ªæ¨¡å¼ `task_create: task_schema.TaskCreate`â€‹ ä½œä¸ºå‚æ•°ã€‚
2. å°†å…¶è½¬æ¢ä¸ºæ•°æ®åº“æ¨¡å‹ `task_model.Task`â€‹
3. æäº¤åˆ°æ•°æ®åº“
4. æ ¹æ®æ•°æ®åº“ä¸Šçš„æ•°æ®æ›´æ–°ä»»åŠ¡å®ä¾‹ `task`â€‹ï¼ˆåœ¨æœ¬ä¾‹ä¸­ï¼Œè·å–åˆ›å»ºè®°å½•çš„ `id`â€‹ï¼‰
5. è¿”å›åˆ›å»ºçš„æ•°æ®åº“æ¨¡å‹

è¿™æ˜¯å¤§è‡´çš„æµç¨‹ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‡½æ•°å®šä¹‰æ˜¯ `async def`â€‹ï¼Œå¹¶ä¸” `db.commit()`â€‹ å’Œ `db.refresh(task)`â€‹ éƒ½å¸¦æœ‰ `await`â€‹ã€‚

â€‹`async def`â€‹ è¡¨ç¤ºè¿™ä¸ªå‡½æ•°å¯ä»¥æ‰§è¡Œå¼‚æ­¥å¤„ç†ï¼Œæ˜¯ä¸€ä¸ª\*\*ã€Œåç¨‹å‡½æ•°ã€\*\*ï¼ˆä»¥ä¸‹ç®€ç§°åç¨‹ï¼‰ã€‚`await`â€‹ è¡¨ç¤ºè¿™é‡Œä¼šå‘ç”Ÿå¼‚æ­¥å¤„ç†ï¼Œå³æ•°æ®åº“è¿æ¥ï¼ˆIOæ“ä½œï¼‰ï¼Œæ„å‘³ç€ã€Œè¿™é‡Œå°†è¿›è¡Œè€—æ—¶çš„æ“ä½œã€ã€‚è¿™ä½¿å¾—Pythonèƒ½å¤Ÿåœ¨äº‹ä»¶å¾ªç¯ä¸­æš‚æ—¶ç¦»å¼€è¿™ä¸ªåç¨‹çš„å¤„ç†ï¼Œè½¬è€Œå¤„ç†å…¶ä»–åç¨‹ã€‚è¿™æ˜¯å¼‚æ­¥å¹¶è¡Œå¤„ç†çš„æ ¸å¿ƒã€‚

!**ä»€ä¹ˆæ˜¯åç¨‹**ã€€ åç¨‹æ˜¯å­ç¨‹åºï¼ˆä¸æ˜¯åç¨‹çš„æ™®é€šå‡½æ•°ï¼‰çš„ä¸€èˆ¬å½¢å¼ã€‚ä½ å¯èƒ½ä¼šæƒ³ï¼Œç›¸å¯¹äº `def`â€‹ï¼Œ`async def`â€‹ æ›´åƒæ˜¯ç‰¹æ®Šå½¢å¼ã€‚æ™®é€šçš„å‡½æ•°åªèƒ½æ‰§è¡ŒåŒæ­¥æ“ä½œï¼Œè€Œåç¨‹æ—¢å¯ä»¥æ‰§è¡ŒåŒæ­¥æ“ä½œä¹Ÿå¯ä»¥æ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œå› æ­¤å®ƒæ˜¯ä¸€èˆ¬å½¢å¼ã€‚

## è·¯ç”±å™¨

ä¸Šè¿°CRUDså®šä¹‰çš„è·¯ç”±å™¨å¯ä»¥è¿™æ ·é‡å†™ã€‚

api/routers/task.py

```
-from fastapi import APIRouter
+from fastapi import APIRouter, Depends
+from sqlalchemy.ext.asyncio import AsyncSession
 
+import api.cruds.task as task_crud
+from api.db import get_db
```

api/routers/task.py

```
-@router.post("/tasks")
-async def create_task():
-    pass
+@router.post("/tasks", response_model=task_schema.TaskCreateResponse)
+async def create_task(
+    task_body: task_schema.TaskCreate, db: AsyncSession = Depends(get_db)
+):
+    return await task_crud.create_task(db, task_body)
```

å› æ­¤ï¼Œ`create_task()`â€‹ çš„è¿”å›å€¼ä¹Ÿä½¿ç”¨ `await`â€‹ è¿”å›ã€‚

å¦‚æœä½ å¿˜è®°äº†æŒ‡å®š `await`â€‹ ä¼šæ€æ ·å‘¢ï¼Ÿ

æ­£å¦‚æˆ‘ä»¬ä¹‹å‰è§£é‡Šçš„ï¼Œç”¨ `async def`â€‹ å®šä¹‰çš„åç¨‹å¯ä»¥æ‰§è¡ŒåŒæ­¥æ“ä½œã€‚å› æ­¤ï¼ŒPythonä¸ä¼šæŠ›å‡ºè¯­æ³•é”™è¯¯ã€‚ä½†æ˜¯ï¼Œå®ƒä¼šåœ¨æ²¡æœ‰ç­‰å¾… `task_crud.create_task(db, task_body)`â€‹ çš„å“åº”çš„æƒ…å†µä¸‹è¿”å›å“åº”ï¼Œå¯¼è‡´ä»¥ä¸‹é”™è¯¯ã€‚

```
pydantic.error_wrappers.ValidationError: 1 validation error for TaskCreateResponse
response -> id
  field required (type=value_error.missing)
```

### æ•°æ®åº“æ¨¡å‹ä¸å“åº”æ¨¡å¼çš„è½¬æ¢

å…³äºè¯·æ±‚ä½“çš„ `task_schema.TaskCreate`â€‹ å’Œå“åº”æ¨¡å‹çš„ `task_schema.TaskCreateResponse`â€‹ï¼Œå¦‚[ç¬¬9ç« çš„å“åº”æ¨¡å¼](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/2c02d7)æ‰€è¿°ï¼Œéœ€è¦åœ¨å“åº”ä¸­é™„åŠ  `id`â€‹ å¹¶è¿”å›ã€‚

api/schemas/task.py

```python
class TaskBase(BaseModel):
    title: Optional[str] = Field(None, example="ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å–ã‚Šã«è¡Œã")


class TaskCreate(TaskBase):
    pass


class TaskCreateResponse(TaskCreate):
    id: int

    class Config:
        orm_mode = True
```

è¿™é‡Œï¼Œ`orm_mode = True`â€‹ æ„å‘³ç€è¿™ä¸ªå“åº”æ¨¡å¼ `TaskCreateResponse`â€‹ å°†éšå¼åœ°æ¥å—ORMï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºå“åº”æ¨¡å¼ã€‚

è¯æ®æ˜¯ï¼Œ`task_crud.create_task(db, task_body)`â€‹ è¿”å›çš„æ˜¯æ•°æ®åº“æ¨¡å‹ `task_model.Task`â€‹ï¼Œä½†APIæ­£ç¡®åœ°å°†å…¶è½¬æ¢ä¸º `TaskCreateResponse`â€‹ã€‚è¿™æ˜¯é€šè¿‡å†…éƒ¨ä½¿ç”¨ `TaskCreateResponse`â€‹ åˆå§‹åŒ– `task_model.Task`â€‹ çš„å„ä¸ªå­—æ®µæ¥å®ç°çš„ã€‚

### DI

è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿè¦æ³¨æ„ `db: AsyncSession = Depends(get_db)`â€‹ã€‚

â€‹`Depends`â€‹ æ˜¯ä¸€ä¸ªå‚æ•°å‡½æ•°ï¼Œæ‰§è¡Œ **DIï¼ˆDependency Injectionï¼Œä¾èµ–æ³¨å…¥ï¼‰** ã€‚

é€šè¿‡åœ¨DBè¿æ¥éƒ¨åˆ†ä½¿ç”¨DIï¼Œå¯ä»¥é˜²æ­¢ä¸šåŠ¡é€»è¾‘å’ŒDBç´§å¯†è€¦åˆã€‚æ­¤å¤–ï¼Œç”±äºDIå…è®¸ä»å¤–éƒ¨è¦†ç›–è¿™ä¸ª `db`â€‹ å®ä¾‹çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼Œåœ¨æµ‹è¯•æ—¶å¯ä»¥ä¸æ¥è§¦ç”Ÿäº§ä»£ç å°±å°† `get_db`â€‹ æ›¿æ¢ä¸ºä¸åŒçš„æµ‹è¯•è¿æ¥ã€‚

æˆ‘ä»¬å°†åœ¨[ç¬¬13ç«  å•å…ƒæµ‹è¯•](https://zenn.dev/sh0nk/books/537bb028709ab9/viewer/d3f074)ä¸­å†æ¬¡è§£é‡Šå¦‚ä½•åˆ©ç”¨è¿™ç§æœºåˆ¶è¿›è¡Œæµ‹è¯•ã€‚

## æ“ä½œç¡®è®¤

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°è¯•é€šè¿‡Swagger UIè®¿é—® `POST`â€‹ `/tasks`â€‹ ç«¯ç‚¹ã€‚æ¯æ¬¡æŒ‰ä¸‹ã€ŒExecuteã€æ—¶ï¼Œéƒ½ä¼šå¢åŠ  `id`â€‹ å¹¶è¿”å›ç»“æœã€‚

# R: è¯»å–

ç°åœ¨æˆ‘ä»¬å¯ä»¥åˆ›å»º `Task`â€‹ äº†ï¼Œæ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ª `Read`â€‹ ç«¯ç‚¹æ¥æ¥æ”¶ `Task`â€‹ åˆ—è¡¨ã€‚ åœ¨ToDoåº”ç”¨ä¸­ï¼Œ`Task`â€‹ å¯¹åº”äº `Done`â€‹ æ¨¡å‹ï¼Œä½†å•ç‹¬è·å–è¿™äº› `Read`â€‹ æ˜¯ä¸æ–¹ä¾¿çš„ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç«¯ç‚¹ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥è·å–ä¸€ä¸ªå¸¦æœ‰å®Œæˆæ ‡è®° `done`â€‹ çš„ToDoä»»åŠ¡åˆ—è¡¨ã€‚

## CRUDs

ä¸ºäº†è¿›è¡Œjoinï¼ŒCRUDså®šä¹‰å°†å˜å¾—æœ‰ç‚¹å¤æ‚ã€‚

api/cruds/task.py

```python
from typing import List, Tuple

from sqlalchemy import select
from sqlalchemy.engine import Result


async def get_tasks_with_done(db: AsyncSession) -> List[Tuple[int, str, bool]]:
    result: Result = await (
        db.execute(
            select(
                task_model.Task.id,
                task_model.Task.title,
                task_model.Done.id.isnot(None).label("done"),
            ).outerjoin(task_model.Done)
        )
    )
    return result.all()
```

é¦–å…ˆï¼Œ`get_tasks_with_done()`â€‹ ä¹Ÿæ˜¯ä¸€ä¸ªåç¨‹ï¼Œå› æ­¤å®ƒä½¿ç”¨ `async def`â€‹ å®šä¹‰ï¼Œå¹¶ä½¿ç”¨ `await`â€‹ è·å– `Result`â€‹ã€‚

å®é™…ä¸Šï¼Œè¿™ä¸ª `Result`â€‹ å®ä¾‹åœ¨è¿™ä¸€ç‚¹ä¸Šè¿˜æ²¡æœ‰æ‰€æœ‰çš„DBè¯·æ±‚ç»“æœã€‚ä¸ºäº†åœ¨å¤„ç†DBè®°å½•æ—¶æœ‰æ•ˆåœ°ä½¿ç”¨forå¾ªç¯ç­‰ï¼Œå®ƒè¢«å®šä¹‰ä¸ºä¸€ä¸ªè¿­ä»£å™¨ã€‚è¿™æ¬¡æˆ‘ä»¬æ²¡æœ‰è¿›è¡Œä»»ä½•é‡çš„å¾ªç¯å¤„ç†ï¼Œæ‰€ä»¥ä½œä¸ºåç¨‹çš„è¿”å›å€¼ï¼Œæˆ‘ä»¬é€šè¿‡ `result.all()`â€‹ è°ƒç”¨é¦–æ¬¡è·å–æ‰€æœ‰DBè®°å½•ã€‚

â€‹`select()`â€‹ ç”¨äºæŒ‡å®šæ‰€éœ€çš„å­—æ®µï¼Œ`.outerjoin()`â€‹ ç”¨äºæŒ‡å®šè¦joinçš„æ¨¡å‹ã€‚

å¦å¤–ï¼Œæ­£å¦‚æˆ‘ä»¬æ‰€è§£é‡Šçš„ï¼Œ`dones`â€‹ è¡¨å…·æœ‰ä¸ `tasks`â€‹ è¡¨ç›¸åŒçš„IDï¼Œå¹¶ä¸”åªæœ‰å½“ToDoä»»åŠ¡å®Œæˆæ—¶æ‰ä¼šå­˜åœ¨è®°å½•ã€‚`task_model.Done.id.isnot(None).label("done")`â€‹ ç”¨äºè¿”å›ä¸€ä¸ªå¸¦æœ‰ `done=True`â€‹ çš„joinè®°å½•ï¼Œå¦‚æœ `Done.id`â€‹ å­˜åœ¨ï¼Œå¦åˆ™ `done=False`â€‹

## è·¯ç”±å™¨

ä¸Šè¿°CRUDså®šä¹‰çš„è·¯ç”±å™¨å‡ ä¹ä¸ `Create`â€‹ çš„ç›¸åŒã€‚

api/routers/task.py

```python
@router.get("/tasks", response_model=List[task_schema.Task])
async def list_tasks(db: AsyncSession = Depends(get_db)):
    return await task_crud.get_tasks_with_done(db)
```

## æ“ä½œç¡®è®¤

åˆ›å»ºäº†å¤šå°‘æ¬¡ `Create`â€‹ï¼Œå°±ä¼šåˆ›å»ºå¤šå°‘TODOä»»åŠ¡ï¼Œå¹¶ä¸”æ‰€æœ‰è¿™äº›éƒ½å°†ä½œä¸ºåˆ—è¡¨è¿”å›ã€‚

æ­¤å¤–ï¼Œä¸ä»…ä»…æ˜¯çº¯ç²¹çš„ `tasks`â€‹ è¡¨çš„å†…å®¹ï¼Œæ¯ä¸ªTODOä»»åŠ¡éƒ½ä¼šé™„åŠ ä¸€ä¸ªå®Œæˆæ ‡å¿— `done`â€‹ã€‚ç”±äºæˆ‘ä»¬è¿˜æ²¡æœ‰å®šä¹‰æœ‰å…³ `done`â€‹ èµ„æºçš„ç«¯ç‚¹ï¼Œæ‰€ä»¥ç›®å‰è¿™äº›éƒ½æ˜¯ `false`â€‹ã€‚


# U: æ›´æ–°

â€‹`Update`â€‹ ä¹Ÿä¸ `Create`â€‹ å‡ ä¹ç›¸åŒï¼Œä½†é¦–å…ˆæ£€æŸ¥è¯·æ±‚çš„ `Task`â€‹ æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–°ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›404é”™è¯¯ã€‚

## CRUDs

æˆ‘ä»¬å®šä¹‰ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°ã€‚

api/cruds/task.py

```python
from typing import List, Tuple, Optional


async def get_task(db: AsyncSession, task_id: int) -> Optional[task_model.Task]:
    result: Result = await db.execute(
        select(task_model.Task).filter(task_model.Task.id == task_id)
    )
    task: Optional[Tuple[task_model.Task]] = result.first()
    return task[0] if task is not None else None  # è¦ç´ ãŒä¸€ã¤ã§ã‚ã£ã¦ã‚‚tupleã§è¿”å´ã•ã‚Œã‚‹ã®ã§ï¼‘ã¤ç›®ã®è¦ç´ ã‚’å–ã‚Šå‡ºã™


async def update_task(
    db: AsyncSession, task_create: task_schema.TaskCreate, original: task_model.Task
) -> task_model.Task:
    original.title = task_create.title
    db.add(original)
    await db.commit()
    await db.refresh(original)
    return original
```

â€‹`get_task()`â€‹ ä½¿ç”¨ `.filter()`â€‹ ä½œä¸ºSELECT \~ WHEREæ¥è¿‡æ»¤ç›®æ ‡ã€‚ å¦å¤–ï¼Œ`Result`â€‹ å³ä½¿åªæŒ‡å®šäº†ä¸€ä¸ªå…ƒç´ ä¹Ÿä¼šä»¥å…ƒç»„çš„å½¢å¼è¿”å›ï¼Œæ‰€ä»¥éœ€è¦flattenå¤„ç†ä»¥å–å‡ºå€¼ã€‚è¯·æ³¨æ„è¿™é‡Œçš„å†™æ³•æœ‰ç‚¹å¤æ‚ã€‚

â€‹`update_task()`â€‹ çœ‹èµ·æ¥å’Œ `create_task()`â€‹ å‡ ä¹ä¸€æ ·ã€‚å®ƒæ¥å—ä¸€ä¸ªDBæ¨¡å‹ `original`â€‹ ä½œä¸ºå‚æ•°ï¼Œå¹¶æ›´æ–°å…¶å†…å®¹ç„¶åè¿”å›ã€‚

## è·¯ç”±å™¨

ä¸Šè¿°CRUDså®šä¹‰çš„è·¯ç”±å™¨å¦‚ä¸‹ã€‚

api/routers/task.py

```python
from fastapi import APIRouter, Depends, HTTPException


@router.put("/tasks/{task_id}", response_model=task_schema.TaskCreateResponse)
async def update_task(
    task_id: int, task_body: task_schema.TaskCreate, db: AsyncSession = Depends(get_db)
):
    task = await task_crud.get_task(db, task_id=task_id)
    if task is None:
        raise HTTPException(status_code=404, detail="Task not found")

    return await task_crud.update_task(db, task_body, original=task)
```

è¿™é‡Œï¼ŒHTTPException æ˜¯ä¸€ä¸ªå¯ä»¥æ¥å—ä»»æ„HTTPçŠ¶æ€ä»£ç çš„ Exception ç±»ã€‚è¿™æ¬¡æˆ‘ä»¬æŒ‡å®š 404 Not Found å¹¶æŠ›å‡ºå®ƒã€‚

## æ“ä½œç¡®è®¤

è®©æˆ‘ä»¬å°è¯•æ›´æ”¹ `task_id=1`â€‹ çš„æ ‡é¢˜ã€‚

é€šè¿‡ Read æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®è®¤æ›´æ”¹åçš„ç»“æœã€‚


# D: åˆ é™¤

## CRUDs

Delete æ¥å£ä¹Ÿä¸ Update å‡ ä¹ç›¸åŒã€‚é¦–å…ˆæ‰§è¡Œ get_taskï¼Œç„¶åæ‰§è¡Œ delete_taskã€‚

api/cruds/task.py

```python
async def delete_task(db: AsyncSession, original: task_model.Task) -> None:
    await db.delete(original)
    await db.commit()
```

## è·¯ç”±å™¨

ä¸Šè¿°CRUDså®šä¹‰çš„è·¯ç”±å™¨å¦‚ä¸‹ã€‚

api/routers/task.py

```python
@router.delete("/tasks/{task_id}", response_model=None)
async def delete_task(task_id: int, db: AsyncSession = Depends(get_db)):
    task = await task_crud.get_task(db, task_id=task_id)
    if task is None:
        raise HTTPException(status_code=404, detail="Task not found")

    return await task_crud.delete_task(db, original=task)
```

## æ“ä½œç¡®è®¤

è®©æˆ‘ä»¬å°è¯•åˆ é™¤ `task_id=2`â€‹ã€‚


å†æ¬¡æ‰§è¡Œæ—¶ï¼Œç”±äºåˆ é™¤å·²ç»å®Œæˆï¼Œä¼šè¿”å› 404 é”™è¯¯ã€‚


é€šè¿‡ Read æ¥å£ä¹Ÿå¯ä»¥ç¡®è®¤åˆ é™¤å·²ç»å®Œæˆã€‚


# Doneèµ„æº

ä¸Taskèµ„æºç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿå°†å®šä¹‰Doneèµ„æºã€‚

æˆ‘ä»¬å°†åŒæ—¶æŸ¥çœ‹CRUDså’Œè·¯ç”±å™¨ã€‚

api/cruds/done.py

```python
from typing import Tuple, Optional

from sqlalchemy import select
from sqlalchemy.engine import Result
from sqlalchemy.ext.asyncio import AsyncSession

import api.models.task as task_model


async def get_done(db: AsyncSession, task_id: int) -> Optional[task_model.Done]:
    result: Result = await db.execute(
        select(task_model.Done).filter(task_model.Done.id == task_id)
    )
    done: Optional[Tuple[task_model.Done]] = result.first()
    return done[0] if done is not None else None  # è¦ç´ ãŒä¸€ã¤ã§ã‚ã£ã¦ã‚‚tupleã§è¿”å´ã•ã‚Œã‚‹ã®ã§ï¼‘ã¤ç›®ã®è¦ç´ ã‚’å–ã‚Šå‡ºã™


async def create_done(db: AsyncSession, task_id: int) -> task_model.Done:
    done = task_model.Done(id=task_id)
    db.add(done)
    await db.commit()
    await db.refresh(done)
    return done


async def delete_done(db: AsyncSession, original: task_model.Done) -> None:
    await db.delete(original)
    await db.commit()
```

api/routers/done.py

```python
from fastapi import APIRouter, HTTPException, Depends
from sqlalchemy.ext.asyncio import AsyncSession

import api.schemas.done as done_schema
import api.cruds.done as done_crud
from api.db import get_db

router = APIRouter()


@router.put("/tasks/{task_id}/done", response_model=done_schema.DoneResponse)
async def mark_task_as_done(task_id: int, db: AsyncSession = Depends(get_db)):
    done = await done_crud.get_done(db, task_id=task_id)
    if done is not None:
        raise HTTPException(status_code=400, detail="Done already exists")

    return await done_crud.create_done(db, task_id)


@router.delete("/tasks/{task_id}/done", response_model=None)
async def unmark_task_as_done(task_id: int, db: AsyncSession = Depends(get_db)):
    done = await done_crud.get_done(db, task_id=task_id)
    if done is None:
        raise HTTPException(status_code=404, detail="Done not found")

    return await done_crud.delete_done(db, original=done)
```

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå“åº”æ¨¡å¼ï¼Œæ‰€ä»¥åŒæ—¶åˆ›å»º api/schemas/done.pyã€‚

api/schemas/done.py

```python
from pydantic import BaseModel


class DoneResponse(BaseModel):
    id: int

    class Config:
        orm_mode = True
```

è¯·æ³¨æ„ï¼Œæ ¹æ®æ¡ä»¶ï¼Œä¼šæœ‰ä»¥ä¸‹è¡Œä¸ºï¼š

* å½“å®Œæˆæ ‡å¿—æœªè®¾ç½®æ—¶

  * PUT: å®Œæˆæ ‡å¿—å°†è¢«è®¾ç½®
  * DELETE: ç”±äºæ²¡æœ‰æ ‡å¿—ï¼Œè¿”å› `404`â€‹ é”™è¯¯
* å½“å®Œæˆæ ‡å¿—å·²è®¾ç½®æ—¶

  * PUT: ç”±äºå·²ç»è®¾ç½®äº†æ ‡å¿—ï¼Œè¿”å› `400`â€‹ é”™è¯¯
  * DELETE: æ¸…é™¤å®Œæˆæ ‡å¿—

## æ“ä½œç¡®è®¤

é€šè¿‡æ‰§è¡ŒDoneèµ„æºçš„ `Create`â€‹ï¼Œå¯ä»¥ç¡®è®¤åœ¨Taskèµ„æºçš„ `Read`â€‹ ç•Œé¢ä¸Šï¼Œ `done`â€‹ æ ‡å¿—æ˜¯å¯ä»¥æ“ä½œçš„ã€‚


# æœ€ç»ˆç›®å½•ç»“æ„

æ­å–œä½ ï¼åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å®šä¹‰äº†æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶æ¥è¿è¡ŒToDoåº”ç”¨ã€‚ğŸ‰ æœ€ç»ˆï¼Œæ–‡ä»¶ç»“æ„åº”è¯¥å¦‚ä¸‹ã€‚

```bash
api
â”œâ”€â”€ __init__.py
â”œâ”€â”€ db.py
â”œâ”€â”€ main.py
â”œâ”€â”€ migrate_db.py
â”œâ”€â”€ cruds
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ done.py
â”‚   â””â”€â”€ task.py
â”œâ”€â”€ models
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ task.py
â”œâ”€â”€ routers
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ done.py
â”‚   â””â”€â”€ task.py
â””â”€â”€ schemas
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ done.py
    â””â”€â”€ task.py
```

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‰€æœ‰çš„è¡Œä¸ºéƒ½å¯ä»¥é€šè¿‡Swagger UIæ¥ç¡®è®¤ã€‚

å³ä½¿ä¸é€šè¿‡Swagger UIç¡®è®¤ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨æ›´æ”¹æ—¶å°½æ—©å‘ç°é”™è¯¯ï¼Œä¸‹ä¸€ç« æˆ‘ä»¬å°†ç¼–å†™å•å…ƒæµ‹è¯•ã€‚

â€

---
æœ¬æ–‡æ˜¯ä¸ªäººå­¦ä¹ è®°å½•ï¼Œå¦‚æœæœ‰ä¾µæƒè¯·è”ç³»ååˆ é™¤ã€‚
